<!-- Navigation -->
{% assign invert_nav = false %}
{% if page['nav-style'] == 'invert' or page['header-style'] == 'text' %}
  {% assign invert_nav = true %}
{% endif %}
<nav class="navbar navbar-default navbar-custom navbar-fixed-top{% if invert_nav %} invert{% endif %}">
  <div class="container-fluid">
    <!-- Brand and toggle -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle" aria-label="切换导航">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="{{ '/' | relative_url }}">{{ site.title }}</a>
    </div>

    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <!-- 固定主菜单（目录式路径） -->
          <li{% if page.url == '/' or page.permalink == '/' %} class="active"{% endif %}>
            <a href="{{ '/' | relative_url }}">首页</a>
          </li>
          <li{% if page.url == '/archive/' %} class="active"{% endif %}>
            <a href="{{ '/archive/' | relative_url }}">归档</a>
          </li>
          <li{% if page.url == '/about/' %} class="active"{% endif %}>
            <a href="{{ '/about/' | relative_url }}">关于</a>
          </li>
          <li{% if page.url == '/meaning-test/' %} class="active"{% endif %}>
            <a href="{{ '/meaning-test/' | relative_url }}">意义测试</a>
          </li>
          <li{% if page.url == '/projects/' %} class="active"{% endif %}>
            <a href="{{ '/projects/' | relative_url }}">未来项目</a>
          </li>
          <li{% if page.url == '/core-test/' %} class="active"{% endif %}>
            <a href="{{ '/core-test/' | relative_url }}">核心测试</a>
          </li>

          {%- comment -%}
          动态追加其它页面：
          - 在任意页面 Front-Matter 设置 hide-in-nav: true 可隐藏
          - 避免与固定项重复（按目录式 URL 过滤）
          {%- endcomment -%}
          {% assign fixed_urls = '/,/archive/,/about/,/meaning-test/,/projects/,/core-test/' | split: ',' %}
          {% for p in site.pages %}
            {% if p.title and p.hide-in-nav != true %}
              {%- assign p_url = p.url -%}

              {%- comment -%} 统一把没有结尾斜杠的路径规范化（仅对非根且非静态资源） {%- endcomment -%}
              {% unless p_url == '/' %}
                {% unless p_url contains '.' %}
                  {% assign last_char = p_url | slice: -1, 1 %}
                  {% if last_char != '/' %}
                    {% assign p_url = p_url | append: '/' %}
                  {% endif %}
                {% endunless %}
              {% endunless %}

              {%- assign dup = false -%}
              {% for fu in fixed_urls %}
                {% if p_url == fu %}{% assign dup = true %}{% break %}{% endif %}
              {% endfor %}

              {% if dup == false %}
                <li{% if page.url == p.url or page.url == p_url %} class="active"{% endif %}>
                  <a href="{{ p_url | relative_url }}">{{ p.title }}</a>
                </li>
              {% endif %}
            {% endif %}
          {% endfor %}

          <!-- 搜索 -->
          <li class="search-icon">
            <a href="javascript:void(0)" aria-label="搜索">
              <i class="fa fa-search"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</nav>

<script>
  // 自定义导航开合（保持主题原逻辑）
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  var __HuxNav__ = {
    close: function () {
      $navbar.className = " ";
      setTimeout(function () {
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px";
        }
      }, 400);
    },
    open: function () {
      $collapse.style.height = "auto";
      if ($navbar.className.indexOf('in') < 0) {
        $navbar.className += " in";
      }
    }
  };

  if ($toggle) {
    $toggle.addEventListener('click', function () {
      if ($navbar.className.indexOf('in') > 0) __HuxNav__.close();
      else __HuxNav__.open();
    });
  }

  // 点击空白处关闭，避免与 FastClick 冲突
  document.addEventListener('click', function (e) {
    if (e.target === $toggle) return;
    if (e.target.className === 'icon-bar') return;
    __HuxNav__.close();
  });
</script>
